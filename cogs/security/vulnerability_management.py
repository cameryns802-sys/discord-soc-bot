"""Vulnerability Management System: Command group"""
import discord
from discord.ext import commands
from discord import app_commands
import json
import os
from datetime import datetime
from cogs.core.pst_timezone import get_now_pst

class VulnGroup(app_commands.Group):
    def __init__(self, cog):
        super().__init__(name="vuln", description="Vulnerability management commands")
        self.cog = cog

    @app_commands.command(name="add", description="Add new vulnerability")
    @app_commands.checks.has_permissions(moderate_members=True)
    async def add(self, interaction: discord.Interaction, cve_id: str, severity: str, description: str):
        if severity.lower() not in ["critical", "high", "medium", "low"]:
            await interaction.response.send_message("❌ Severity must be: critical, high, medium, low", ephemeral=True)
            return
        self.cog.vuln_counter += 1
        vuln_id = f"VULN-{self.cog.vuln_counter:05d}"
        self.cog.vulnerabilities[vuln_id] = {"id": vuln_id, "cve_id": cve_id, "severity": severity.lower(), "description": description, "status": "open", "reported_by": interaction.user.id, "reported_at": get_now_pst().isoformat(), "cvss_score": 0.0}
        self.cog.save_data()
        embed = discord.Embed(title=f"🔴 Vulnerability #{vuln_id}", description=f"CVE: {cve_id}", color=discord.Color.red())
        embed.add_field(name="Severity", value=severity.upper(), inline=True)
        embed.add_field(name="Status", value="OPEN", inline=True)
        await interaction.response.send_message(embed=embed)

    @app_commands.command(name="list", description="List vulnerabilities")
    async def list(self, interaction: discord.Interaction, status: str = "open"):
        vulns = [v for v in self.cog.vulnerabilities.values() if v['status'] == status.lower()]
        if not vulns:
            await interaction.response.send_message(f"ℹ️ No {status} vulnerabilities", ephemeral=True)
            return
        embed = discord.Embed(title=f"🔍 {status.upper()} Vulnerabilities", color=discord.Color.red())
        for vuln in vulns[:15]:
            embed.add_field(name=f"{vuln['id']} - {vuln['severity'].upper()}", value=f"CVE: {vuln['cve_id']}\n{vuln['description'][:100]}", inline=False)
        await interaction.response.send_message(embed=embed)

    @app_commands.command(name="detail", description="View vulnerability details")
    async def detail(self, interaction: discord.Interaction, vuln_id: str):
        if vuln_id not in self.cog.vulnerabilities:
            await interaction.response.send_message("❌ Vulnerability not found", ephemeral=True)
            return
        vuln = self.cog.vulnerabilities[vuln_id]
        embed = discord.Embed(title=f"Vulnerability {vuln['id']}", description=vuln['description'], color=discord.Color.red())
        embed.add_field(name="CVE ID", value=vuln['cve_id'], inline=True)
        embed.add_field(name="Severity", value=vuln['severity'].upper(), inline=True)
        embed.add_field(name="Status", value=vuln['status'].upper(), inline=True)
        embed.add_field(name="CVSS Score", value=vuln.get('cvss_score', 'N/A'), inline=True)
        embed.add_field(name="Reported", value=vuln['reported_at'][:10], inline=True)
        await interaction.response.send_message(embed=embed)

    @app_commands.command(name="remediate", description="Mark vulnerability as remediated")
    @app_commands.checks.has_permissions(moderate_members=True)
    async def remediate(self, interaction: discord.Interaction, vuln_id: str):
        if vuln_id not in self.cog.vulnerabilities:
            await interaction.response.send_message("❌ Vulnerability not found", ephemeral=True)
            return
        self.cog.vulnerabilities[vuln_id]['status'] = 'remediated'
        self.cog.vulnerabilities[vuln_id]['remediated_at'] = get_now_pst().isoformat()
        self.cog.save_data()
        await interaction.response.send_message(f"✅ Vulnerability {vuln_id} marked as remediated")

    @app_commands.command(name="assign", description="Assign vulnerability to user")
    @app_commands.checks.has_permissions(moderate_members=True)
    async def assign(self, interaction: discord.Interaction, vuln_id: str, assignee: discord.Member):
        if vuln_id not in self.cog.vulnerabilities:
            await interaction.response.send_message("❌ Vulnerability not found", ephemeral=True)
            return
        self.cog.vulnerabilities[vuln_id]['assigned_to'] = assignee.id
        self.cog.save_data()
        await interaction.response.send_message(f"✅ Vulnerability {vuln_id} assigned to {assignee.mention}")

    @app_commands.command(name="stats", description="View vulnerability statistics")
    async def stats(self, interaction: discord.Interaction):
        open_count = len([v for v in self.cog.vulnerabilities.values() if v['status'] == 'open'])
        remediated = len([v for v in self.cog.vulnerabilities.values() if v['status'] == 'remediated'])
        critical = len([v for v in self.cog.vulnerabilities.values() if v['severity'] == 'critical' and v['status'] == 'open'])
        embed = discord.Embed(title="📊 Vulnerability Statistics", color=discord.Color.blue())
        embed.add_field(name="Total Vulnerabilities", value=len(self.cog.vulnerabilities), inline=True)
        embed.add_field(name="Open", value=open_count, inline=True)
        embed.add_field(name="Remediated", value=remediated, inline=True)
        embed.add_field(name="Critical Open", value=critical, inline=True)
        await interaction.response.send_message(embed=embed)

    @app_commands.command(name="scan", description="Run vulnerability scan")
    @app_commands.checks.has_permissions(moderate_members=True)
    async def scan(self, interaction: discord.Interaction):
        await interaction.response.defer()
        embed = discord.Embed(title="🔍 Vulnerability Scan Complete", color=discord.Color.green())
        embed.add_field(name="Scanned Assets", value="127", inline=True)
        embed.add_field(name="New Vulnerabilities", value="3", inline=True)
        embed.add_field(name="Critical", value="1", inline=True)
        await interaction.followup.send(embed=embed)

class VulnerabilityManagementCog(commands.Cog):
    def __init__(self, bot):
        self.bot = bot
        self.vulnerabilities = {}
        self.vuln_counter = 0
        self.data_file = "data/vulnerabilities.json"
        self.load_data()
        self.vuln_group = VulnGroup(self)
        bot.tree.add_command(self.vuln_group)

    def load_data(self):
        if os.path.exists(self.data_file):
            try:
                with open(self.data_file, 'r') as f:
                    data = json.load(f)
                    self.vulnerabilities = data.get('vulnerabilities', {})
                    self.vuln_counter = data.get('counter', 0)
            except: pass

    def save_data(self):
        os.makedirs('data', exist_ok=True)
        with open(self.data_file, 'w') as f:
            json.dump({'vulnerabilities': self.vulnerabilities, 'counter': self.vuln_counter}, f, indent=2)

    async def cog_unload(self):
        self.bot.tree.remove_command(self.vuln_group.name)

async def setup(bot):
    await bot.add_cog(VulnerabilityManagementCog(bot))
