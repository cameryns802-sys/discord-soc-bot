# Vulnerability Tracking and Management System
import discord
from discord.ext import commands
import json
import os
from datetime import datetime

DATA_FILE = 'data/vulnerabilities.json'

def load_vulnerabilities():
    if os.path.exists(DATA_FILE):
        try:
            with open(DATA_FILE, 'r') as f:
                return json.load(f)
        except:
            return get_default_vulnerabilities()
    return get_default_vulnerabilities()

def get_default_vulnerabilities():
    return {
        "vulnerabilities": [
            {
                "id": "CVE-2024-001",
                "title": "Critical RCE in Core Service",
                "severity": "critical",
                "cvss_score": 9.8,
                "status": "open",
                "discovered_date": datetime.utcnow().isoformat(),
                "due_date": "2024-01-15",
                "assigned_to": None,
                "description": "Remote Code Execution vulnerability in authentication service",
                "remediation": "Apply patch version 2.1.5 or higher",
                "affected_systems": ["auth-server", "api-gateway"],
                "comments": []
            }
        ],
        "vuln_counter": 1
    }

def save_vulnerabilities(data):
    os.makedirs('data', exist_ok=True)
    with open(DATA_FILE, 'w') as f:
        json.dump(data, f, indent=2)

class VulnerabilityTrackingCog(commands.Cog):
    def __init__(self, bot):
        self.bot = bot

    @commands.command(name='report_vuln')
    async def report_vulnerability(self, ctx, title: str, severity: str, *, description: str):
        """Report a new vulnerability (critical, high, medium, low)"""
        if not await self.is_staff(ctx):
            await ctx.send("âŒ Only security staff can report vulnerabilities")
            return
        
        valid_severities = ['critical', 'high', 'medium', 'low']
        if severity not in valid_severities:
            await ctx.send(f"âŒ Invalid severity. Valid: {', '.join(valid_severities)}")
            return
        
        data = load_vulnerabilities()
        vuln_id = f"CVE-2024-{str(data.get('vuln_counter', 1)).zfill(3)}"
        data['vuln_counter'] = data.get('vuln_counter', 1) + 1
        
        vulnerability = {
            "id": vuln_id,
            "title": title,
            "severity": severity,
            "cvss_score": None,
            "status": "open",
            "discovered_date": datetime.utcnow().isoformat(),
            "due_date": None,
            "assigned_to": None,
            "description": description,
            "remediation": "Pending",
            "affected_systems": [],
            "comments": [],
            "reported_by": ctx.author.id
        }
        
        data['vulnerabilities'].append(vulnerability)
        save_vulnerabilities(data)
        
        severity_emoji = {
            'critical': 'ğŸ”´',
            'high': 'ğŸŸ ',
            'medium': 'ğŸŸ¡',
            'low': 'ğŸŸ¢'
        }.get(severity, 'â“')
        
        embed = discord.Embed(
            title=f"âœ… Vulnerability Reported",
            description=title,
            color=discord.Color.red() if severity == 'critical' else discord.Color.orange()
        )
        embed.add_field(name="Vulnerability ID", value=vuln_id, inline=True)
        embed.add_field(name="Severity", value=f"{severity_emoji} {severity.upper()}", inline=True)
        embed.add_field(name="Status", value="ğŸ”µ Open", inline=True)
        embed.add_field(name="Description", value=description, inline=False)
        embed.add_field(name="Reported By", value=ctx.author.mention, inline=True)
        embed.set_footer(text=f"ID: {vuln_id}")
        
        await ctx.send(embed=embed)

    @commands.command(name='list_vulns')
    async def list_vulnerabilities(self, ctx, severity: str = "all"):
        """List vulnerabilities by severity"""
        data = load_vulnerabilities()
        vulns = data.get('vulnerabilities', [])
        
        if severity != "all":
            vulns = [v for v in vulns if v.get('severity') == severity]
        
        if not vulns:
            await ctx.send(f"No vulnerabilities found with severity: {severity}")
            return
        
        embed = discord.Embed(
            title="ğŸ”“ Vulnerabilities Dashboard",
            description=f"Total: {len(vulns)} vulnerabilities",
            color=discord.Color.red()
        )
        
        severity_counts = {}
        for vuln in data.get('vulnerabilities', []):
            sev = vuln.get('severity')
            severity_counts[sev] = severity_counts.get(sev, 0) + 1
        
        counts_text = " | ".join([f"{k}: {v}" for k, v in severity_counts.items()])
        embed.add_field(name="Distribution", value=counts_text, inline=False)
        
        for vuln in vulns[:8]:
            severity_emoji = {
                'critical': 'ğŸ”´',
                'high': 'ğŸŸ ',
                'medium': 'ğŸŸ¡',
                'low': 'ğŸŸ¢'
            }.get(vuln.get('severity', 'unknown'), 'â“')
            
            status_emoji = {
                'open': 'ğŸ”µ',
                'in_progress': 'ğŸŸ¡',
                'remediated': 'ğŸŸ¢',
                'closed': 'âš«'
            }.get(vuln.get('status', 'unknown'), 'â“')
            
            embed.add_field(
                name=f"{severity_emoji} {vuln.get('id')} - {vuln.get('title')}",
                value=f"{status_emoji} {vuln.get('status').upper()} | CVSS: {vuln.get('cvss_score', 'TBD')}",
                inline=False
            )
        
        embed.set_footer(text="Use !vuln <id> for details")
        await ctx.send(embed=embed)

    @commands.command(name='vuln')
    async def view_vulnerability(self, ctx, vuln_id: str):
        """View vulnerability details"""
        data = load_vulnerabilities()
        vuln = next((v for v in data.get('vulnerabilities', []) if v.get('id') == vuln_id), None)
        
        if not vuln:
            await ctx.send("âŒ Vulnerability not found")
            return
        
        severity_color = {
            'critical': discord.Color.red(),
            'high': discord.Color.orange(),
            'medium': discord.Color.gold(),
            'low': discord.Color.green()
        }.get(vuln.get('severity', 'unknown'), discord.Color.blue())
        
        embed = discord.Embed(
            title=f"ğŸ”“ {vuln.get('id')} - {vuln.get('title')}",
            color=severity_color,
            timestamp=datetime.fromisoformat(vuln.get('discovered_date', datetime.utcnow().isoformat()))
        )
        
        embed.add_field(name="Severity", value=vuln.get('severity').upper(), inline=True)
        embed.add_field(name="CVSS Score", value=str(vuln.get('cvss_score', 'TBD')), inline=True)
        embed.add_field(name="Status", value=vuln.get('status').upper(), inline=True)
        embed.add_field(name="Description", value=vuln.get('description'), inline=False)
        embed.add_field(name="Remediation", value=vuln.get('remediation'), inline=False)
        
        affected = vuln.get('affected_systems', [])
        if affected:
            embed.add_field(name="Affected Systems", value=", ".join(affected), inline=False)
        
        if vuln.get('assigned_to'):
            embed.add_field(name="Assigned To", value=f"<@{vuln.get('assigned_to')}>", inline=True)
        
        if vuln.get('due_date'):
            embed.add_field(name="Due Date", value=vuln.get('due_date'), inline=True)
        
        await ctx.send(embed=embed)

    @commands.command(name='assign_vuln')
    async def assign_vulnerability(self, ctx, vuln_id: str, user: discord.Member):
        """Assign vulnerability to team member"""
        if not await self.is_staff(ctx):
            await ctx.send("âŒ Only staff can assign vulnerabilities")
            return
        
        data = load_vulnerabilities()
        vuln = next((v for v in data.get('vulnerabilities', []) if v.get('id') == vuln_id), None)
        
        if not vuln:
            await ctx.send("âŒ Vulnerability not found")
            return
        
        vuln['assigned_to'] = user.id
        save_vulnerabilities(data)
        
        embed = discord.Embed(
            title="âœ… Vulnerability Assigned",
            color=discord.Color.green()
        )
        embed.add_field(name="Vulnerability ID", value=vuln_id, inline=True)
        embed.add_field(name="Assigned To", value=user.mention, inline=True)
        embed.add_field(name="Assigned By", value=ctx.author.mention, inline=True)
        
        await ctx.send(embed=embed)

    @commands.command(name='remediate_vuln')
    async def remediate_vulnerability(self, ctx, vuln_id: str, *, remediation: str):
        """Set remediation for vulnerability"""
        if not await self.is_staff(ctx):
            await ctx.send("âŒ Only staff can remediate vulnerabilities")
            return
        
        data = load_vulnerabilities()
        vuln = next((v for v in data.get('vulnerabilities', []) if v.get('id') == vuln_id), None)
        
        if not vuln:
            await ctx.send("âŒ Vulnerability not found")
            return
        
        vuln['remediation'] = remediation
        vuln['status'] = 'in_progress'
        save_vulnerabilities(data)
        
        embed = discord.Embed(
            title="âœ… Remediation Updated",
            color=discord.Color.green()
        )
        embed.add_field(name="Vulnerability ID", value=vuln_id, inline=True)
        embed.add_field(name="Status", value="ğŸŸ¡ In Progress", inline=True)
        embed.add_field(name="Remediation", value=remediation, inline=False)
        
        await ctx.send(embed=embed)

    @commands.command(name='close_vuln')
    async def close_vulnerability(self, ctx, vuln_id: str):
        """Close/remediate vulnerability"""
        if not await self.is_staff(ctx):
            await ctx.send("âŒ Only staff can close vulnerabilities")
            return
        
        data = load_vulnerabilities()
        vuln = next((v for v in data.get('vulnerabilities', []) if v.get('id') == vuln_id), None)
        
        if not vuln:
            await ctx.send("âŒ Vulnerability not found")
            return
        
        vuln['status'] = 'remediated'
        vuln['closed_date'] = datetime.utcnow().isoformat()
        save_vulnerabilities(data)
        
        embed = discord.Embed(
            title="âœ… Vulnerability Remediated",
            color=discord.Color.green()
        )
        embed.add_field(name="Vulnerability ID", value=vuln_id, inline=True)
        embed.add_field(name="Status", value="ğŸŸ¢ Remediated", inline=True)
        embed.add_field(name="Closed By", value=ctx.author.mention, inline=True)
        
        await ctx.send(embed=embed)

    async def is_staff(self, ctx):
        return ctx.author.guild_permissions.manage_messages or ctx.author.id == 233662304272834560

async def setup(bot):
    await bot.add_cog(VulnerabilityTrackingCog(bot))
