"""
Vulnerability Remediation Tracker - Track vulnerability remediation progress
Monitor patching timelines, SLAs, and remediation effectiveness
Part of Sentinel Security Operations Center
"""

import discord
from discord.ext import commands
import json
import os
from datetime import datetime, timedelta
import uuid
from cogs.core.pst_timezone import get_now_pst

class VulnerabilityRemediationTracker(commands.Cog):
    """Vulnerability remediation tracking and SLA management"""
    
    def __init__(self, bot):
        self.bot = bot
        self.vulns_file = 'data/vulnerability_remediation.json'
        self.load_data()
    
    def load_data(self):
        """Load vulnerability data"""
        os.makedirs('data', exist_ok=True)
        
        if not os.path.exists(self.vulns_file):
            with open(self.vulns_file, 'w') as f:
                json.dump({}, f)
    
    def get_vulns(self, guild_id):
        """Get vulnerabilities"""
        with open(self.vulns_file, 'r') as f:
            data = json.load(f)
        return data.get(str(guild_id), {})
    
    def save_vulns(self, guild_id, vulns):
        """Save vulnerabilities"""
        with open(self.vulns_file, 'r') as f:
            data = json.load(f)
        data[str(guild_id)] = vulns
        with open(self.vulns_file, 'w') as f:
            json.dump(data, f, indent=2)
    
    def calculate_sla_compliance(self, severity, days_remaining) -> tuple:
        """Calculate SLA compliance percentage"""
        # SLA windows by severity
        sla_windows = {
            'critical': 1,      # 24 hours
            'high': 7,          # 7 days
            'medium': 30,       # 30 days
            'low': 90           # 90 days
        }
        
        window = sla_windows.get(severity, 90)
        
        if days_remaining < 0:
            # Overdue
            compliance = 0
            is_overdue = True
        else:
            compliance = max(0, (days_remaining / window) * 100)
            is_overdue = False
        
        return compliance, is_overdue
    
    async def _logvulnerability_logic(self, ctx, vuln_id: str, severity: str, asset_name: str, patch_available: bool = True):
        """Log vulnerability"""
        vulns = self.get_vulns(ctx.guild.id)
        
        tracking_id = f"VR-{str(uuid.uuid4())[:8].upper()}"
        
        # Set remediation deadline
        severity_days = {
            'critical': 1,
            'high': 7,
            'medium': 30,
            'low': 90
        }
        
        deadline = (get_now_pst() + timedelta(days=severity_days.get(severity, 90))).isoformat()
        
        vuln = {
            'id': tracking_id,
            'vuln_id': vuln_id,
            'severity': severity.lower(),
            'asset': asset_name,
            'discovered_at': get_now_pst().isoformat(),
            'remediation_deadline': deadline,
            'patch_available': patch_available,
            'status': 'open',
            'remediation_status': 'not_started',
            'patch_released': get_now_pst().isoformat() if patch_available else None,
            'patched_systems': 0,
            'total_systems': 15,
            'compliance': 100.0,
            'is_overdue': False
        }
        
        vulns[tracking_id] = vuln
        self.save_vulns(ctx.guild.id, vulns)
        
        embed = discord.Embed(
            title="‚ö†Ô∏è Vulnerability Logged",
            description=f"**{vuln_id}**",
            color=discord.Color.red() if severity == 'critical' else discord.Color.orange(),
            timestamp=get_now_pst()
        )
        
        embed.add_field(name="Tracking ID", value=f"`{tracking_id}`", inline=True)
        embed.add_field(name="Severity", value=severity.upper(), inline=True)
        embed.add_field(name="Status", value="üü† OPEN", inline=True)
        embed.add_field(name="Asset", value=asset_name, inline=True)
        embed.add_field(name="Patch Available", value="‚úÖ Yes" if patch_available else "‚ùå No", inline=True)
        embed.add_field(name="Deadline", value=datetime.fromisoformat(deadline).strftime('%Y-%m-%d'), inline=True)
        
        embed.set_footer(text="Use !vulndetail to track remediation progress")
        
        await ctx.send(embed=embed)
    
    async def _vulndetail_logic(self, ctx, tracking_id: str):
        """Show vulnerability remediation details"""
        vulns = self.get_vulns(ctx.guild.id)
        
        tracking_id = tracking_id.upper()
        if not tracking_id.startswith('VR-'):
            tracking_id = f"VR-{tracking_id}"
        
        vuln = vulns.get(tracking_id)
        if not vuln:
            await ctx.send(f"‚ùå Vulnerability not found: {tracking_id}")
            return
        
        # Calculate days remaining
        deadline = datetime.fromisoformat(vuln['remediation_deadline'])
        days_remaining = (deadline - get_now_pst()).days
        
        compliance, is_overdue = self.calculate_sla_compliance(vuln['severity'], days_remaining)
        
        color = discord.Color.red() if vuln['severity'] == 'critical' else discord.Color.orange() if vuln['severity'] == 'high' else discord.Color.blue()
        
        embed = discord.Embed(
            title=f"‚ö†Ô∏è {vuln['vuln_id']}",
            description=f"Tracking: {tracking_id}",
            color=color,
            timestamp=get_now_pst()
        )
        
        embed.add_field(name="Severity", value=vuln['severity'].upper(), inline=True)
        embed.add_field(name="Asset", value=vuln['asset'], inline=True)
        embed.add_field(name="Status", value=vuln['status'].title(), inline=True)
        
        embed.add_field(name="Timeline", value="‚îÅ" * 25, inline=False)
        embed.add_field(name="Discovered", value=datetime.fromisoformat(vuln['discovered_at']).strftime('%Y-%m-%d'), inline=True)
        embed.add_field(name="Deadline", value=datetime.fromisoformat(vuln['remediation_deadline']).strftime('%Y-%m-%d'), inline=True)
        embed.add_field(name="Days Remaining", value=f"{max(0, days_remaining)}d", inline=True)
        
        embed.add_field(name="SLA Compliance", value="‚îÅ" * 25, inline=False)
        embed.add_field(
            name="Compliance Score",
            value=f"{compliance:.0f}% {'üü¢' if compliance > 80 else 'üü°' if compliance > 50 else 'üî¥'}",
            inline=False
        )
        
        embed.add_field(name="Patch Status", value="‚îÅ" * 25, inline=False)
        patch_available = "‚úÖ Available" if vuln['patch_available'] else "‚è≥ Pending"
        embed.add_field(name="Patch", value=patch_available, inline=True)
        embed.add_field(name="Remediation", value=vuln['remediation_status'].title(), inline=True)
        
        embed.add_field(name="Deployment Progress", value="‚îÅ" * 25, inline=False)
        patched = vuln['patched_systems']
        total = vuln['total_systems']
        bar_length = int((patched / total) * 10)
        bar = "‚ñà" * bar_length + "‚ñë" * (10 - bar_length)
        embed.add_field(
            name="Systems Patched",
            value=f"{bar} {patched}/{total}",
            inline=False
        )
        
        await ctx.send(embed=embed)
    
    async def _vulnstatus_logic(self, ctx):
        """Show vulnerability remediation status"""
        vulns = self.get_vulns(ctx.guild.id)
        
        if not vulns:
            await ctx.send("‚úÖ No vulnerabilities tracked.")
            return
        
        # Categorize
        by_severity = {'critical': [], 'high': [], 'medium': [], 'low': []}
        by_status = {'open': [], 'in_progress': [], 'resolved': []}
        
        for vuln in vulns.values():
            by_severity[vuln['severity']].append(vuln)
            by_status[vuln['status']].append(vuln)
        
        embed = discord.Embed(
            title="üìä Vulnerability Remediation Status",
            description=f"{len(vulns)} vulnerability/vulnerabilities tracked",
            color=discord.Color.blue(),
            timestamp=get_now_pst()
        )
        
        embed.add_field(name="By Severity", value="‚îÅ" * 25, inline=False)
        embed.add_field(name="üî¥ Critical", value=f"{len(by_severity['critical'])} vuln(s)", inline=True)
        embed.add_field(name="üü† High", value=f"{len(by_severity['high'])} vuln(s)", inline=True)
        embed.add_field(name="üü° Medium", value=f"{len(by_severity['medium'])} vuln(s)", inline=True)
        embed.add_field(name="üîµ Low", value=f"{len(by_severity['low'])} vuln(s)", inline=True)
        
        embed.add_field(name="By Remediation Status", value="‚îÅ" * 25, inline=False)
        embed.add_field(name="üî¥ Open", value=f"{len(by_status['open'])} vuln(s)", inline=True)
        embed.add_field(name="üü° In Progress", value=f"{len(by_status['in_progress'])} vuln(s)", inline=True)
        embed.add_field(name="‚úÖ Resolved", value=f"{len(by_status['resolved'])} vuln(s)", inline=True)
        
        # SLA overview
        overdue_count = sum(1 for v in vulns.values() if v['is_overdue'])
        embed.add_field(name="‚ö†Ô∏è SLA Status", value="‚îÅ" * 25, inline=False)
        embed.add_field(
            name="Overdue Remediations",
            value=f"üî¥ {overdue_count}" if overdue_count > 0 else "‚úÖ 0",
            inline=False
        )
        
        # Critical vulns needing attention
        if by_severity['critical']:
            embed.add_field(name="üî¥ Critical Vulnerabilities", value="‚îÅ" * 25, inline=False)
            for vuln in by_severity['critical'][:3]:
                embed.add_field(
                    name=f"{vuln['vuln_id']} ({vuln['id']})",
                    value=f"Asset: {vuln['asset']} | Status: {vuln['status'].title()}",
                    inline=False
                )
        
        await ctx.send(embed=embed)
    
    @commands.command(name='logvulnerability')
    async def logvulnerability_prefix(self, ctx, vuln_id: str, severity: str, asset_name: str, patch_available: str = 'yes'):
        """Log vulnerability - Prefix command"""
        patch = patch_available.lower() == 'yes'
        await self._logvulnerability_logic(ctx, vuln_id, severity, asset_name, patch)
    
    @commands.command(name='vulndetail')
    async def vulndetail_prefix(self, ctx, tracking_id: str):
        """Show vuln details - Prefix command"""
        await self._vulndetail_logic(ctx, tracking_id)
    
    @commands.command(name='vulnstatus')
    async def vulnstatus_prefix(self, ctx):
        """Show vuln status - Prefix command"""
        await self._vulnstatus_logic(ctx)

async def setup(bot):
    await bot.add_cog(VulnerabilityRemediationTracker(bot))
